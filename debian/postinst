#!/bin/bash
# postinst script for jolicloud-tweaks
#
# see: dh_installdeb(1)

set -e

# Application directories
app_dir="/usr/share/jolicloud-tweaks"
save_dir="$app_dir/save"

# Fix the problem with evolution (uninstalled) when the computer is put on AC
if [ -a /etc/acpi/mailbtn.sh ]; then
	chmod -x /etc/acpi/mailbtn.sh
fi

# Remove jolicloud-tweaks earlier (redundant) fix for the shutdown problem.
# The previous fix was not implemented correctly, resulting in an overly
# verbose shutdown which sometimes left the system hanging.
if [ -a /etc/default/halt ]; then
	if [ `cat /etc/default/halt | grep -c "#Automatic fix by jolicloud-tweaks"` -ne 0 ]; then
		sed -i 's/^.*#Automatic fix by jolicloud-tweaks$//' /etc/default/halt
	fi
fi

# Gconf settings
update-gconf-defaults

# Force update of top panel setting by backing out any user customization
old_ifs=$IFS
IFS='
'
hdirs=$(awk -F: '{if ( $3 >= 1000 && $1 != "nobody" ) print $6}' < /etc/passwd)
for d in $hdirs; do
    if [ -d "$d/.gconf/apps/panel" ] ; then
        backuproot="$d/.gconf-backups"
        if [ ! -d $backuproot ] ; then
            mkdir $backuproot
        fi
        backupdir=$(mktemp -d "$backuproot/apps.XXXXXXXXXX")
        mv "$d/.gconf/apps/panel" "$backupdir"
    fi
done

# Change the gdm theme
if [ -d /etc/gdm/ ]; then
	if [ ! -a /etc/gdm/gdm.conf-custom ]; then
		touch /etc/gdm/gdm.conf-custom
	fi
	$app_dir/edit-conf /etc/gdm/gdm.conf-custom greeter BackgroundColor "#000000"
	$app_dir/edit-conf /etc/gdm/gdm.conf-custom greeter GraphicalThemedColor "#000000"
	$app_dir/edit-conf /etc/gdm/gdm.conf-custom greeter GraphicalTheme Jolicloud
fi

# Firefox settings
if [ -e /etc/firefox-3.0/pref/ubufox.js ]; then
	while read LINE ; do
		echo "$LINE //Added by jolicloud-tweaks" >> /etc/firefox-3.0/pref/ubufox.js
	done < /etc/firefox-3.0/pref/jolicloud-firefox.js
fi

# Ubiquity icon
if [ -e /usr/share/pixmaps/ubiquity.png ]; then
	cp -f /usr/share/pixmaps/ubiquity.png /usr/share/jolicloud-tweaks/ubiquity.png.old
	cp -f /usr/share/jolicloud-tweaks/ubiquity.png /usr/share/pixmaps/ubiquity.png
fi

# Updated local icons from the skel
for file in /etc/skel/.local/share/applications/*.desktop; do
	[ -e $file ] || break;
	for homedir in /home/*; do
		cp -a $file $homedir/.local/share/applications
	done
done

# Fix for the wrong repositories in a distributed IMG
sed -i 's/robby/jaunty/g' /etc/apt/sources.list

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.

#DEBHELPER#

exit 0
